# Workflow to apply branch protection rules to make a branch read-only (no direct pushes).
# NOTE: This version is updated to be compatible with older GitHub Enterprise versions
# that do not support the `permissions: administration: write` scope.
name: 'Protect Branch: Make Read-Only'

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'The name of the branch to protect (e.g., main)'
        required: true
        default: 'main'

jobs:
  protect-branch:
    runs-on: ubuntu-latest
    
    # The 'permissions' block has been removed. Instead, this workflow uses a
    # Personal Access Token (PAT) with 'repo' scope, stored as a repository secret.
    # See the setup instructions for creating the PAT and the `REPO_ADMIN_PAT` secret.

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Apply Read-Only Branch Protection'
        env:
          # This now uses a secret containing a PAT instead of the default GITHUB_TOKEN.
          # You must create this secret in your repository settings.
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          # Get the branch name from the manual trigger input.
          BRANCH: ${{ github.event.inputs.branch_name }}
        run: |
          echo "Applying read-only protection rules to branch: $BRANCH"
          
          # Use the GitHub CLI to call the REST API for updating branch protection.
          # This command configures a strict set of rules to prevent direct pushes.
          gh api \
            --method PUT \
            "repos/${{ github.repository }}/branches/$BRANCH/protection" \
            -f "required_status_checks=null" \
            -f "enforce_admins=true" \
            -F "required_pull_request_reviews[required_approving_review_count]=1" \
            -F "required_pull_request_reviews[dismiss_stale_reviews]=false" \
            -F "required_pull_request_reviews[require_code_owner_reviews]=false" \
            -F "restrictions=null" \
            -F "allow_force_pushes=false" \
            -F "allow_deletions=false"

          echo "Successfully applied protection rules to branch: $BRANCH"
